<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Riego Agr√≠cola</title>
    <style>
        /* Agregar variables CSS para el tema */
        :root {
            --primary-color: #4CAF50;
            --primary-dark: #45a049;
            --secondary-color: #2196F3;
            --text-color: #333;
            --bg-color: #fff;
            --card-bg: #f9f9f9;
            --border-color: #e0e0e0;
        }

        [data-theme="dark"] {
            --primary-color: #66bb6a;
            --primary-dark: #4caf50;
            --secondary-color: #42a5f5;
            --text-color: #ffffff;
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --border-color: #404040;
            --input-bg: #333333;
            --input-text: #ffffff;
            --chart-bg: #2d2d2d;
            --chart-grid: #404040;
            --chart-text: #ffffff;
            --result-text: #ffffff;
            --result-bg: #333333;
            --result-border: #404040;
            --history-text: #ffffff;
            --history-bg: #333333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            color: var(--text-color);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-color);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            padding: 15px;
        }

        .input-section, .results-section {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--text-color);
            font-size: 1em;
        }

        .form-group select, 
        .form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: var(--input-bg);
            color: var(--input-text);
        }

        .form-group select:focus, 
        .form-group input:focus {
            outline: none;
            border-color: #4CAF50;
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.2);
        }

        .form-group select option {
            background: var(--input-bg);
            color: var(--input-text);
        }

        .location-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #2196F3, #1976D2);
        }

        .weather-info {
            background: var(--result-bg);
            border: 1px solid var(--result-border);
            color: var(--result-text);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 5px solid #2196F3;
        }

        .weather-info h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .weather-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .weather-item {
            background: rgba(255, 255, 255, 0.7);
            padding: 8px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.9em;
        }

        .tank-visualization {
            margin: 15px 0;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .tank-container {
            width: 100px;
            height: 200px;
            border: 2px solid #333;
            position: relative;
            margin: 20px auto;
            background: #f5f5f5;
            border-radius: 5px;
            overflow: hidden;
        }

        .tank {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .water-level {
            position: absolute;
            bottom: 0;
            width: 100%;
            background-color: #4CAF50;
            transition: height 0.5s ease-in-out;
        }

        .water-level-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #333;
            font-weight: bold;
            z-index: 1;
            text-shadow: 0 0 3px white;
        }

        .tank-info {
            margin-top: 12px;
            background: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .tank-info h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .tank-info p {
            color: var(--text-color);
        }

        .volume-info {
            font-size: 0.9em;
            color: #333;
        }

        .volume-info p {
            margin: 4px 0;
            font-size: 0.9em;
        }

        .recommendation {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            padding: 15px;
            border-radius: 15px;
            border-left: 5px solid #4CAF50;
            margin-top: 15px;
        }

        .recommendation h3 {
            color: #2e7d32;
            margin-bottom: 12px;
            font-size: 1.2em;
        }

        .recommendation-details {
            display: grid;
            gap: 10px;
        }

        .detail-item {
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }

        .detail-label {
            font-weight: 600;
            color: #2e7d32;
        }

        .detail-value {
            font-weight: bold;
            color: #1b5e20;
        }

        .loading {
            text-align: center;
            padding: 15px;
            color: var(--text-color);
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            border-left: 5px solid #f44336;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        /* Nuevos estilos para el historial y gr√°ficos */
        .history-section {
            margin-top: 20px;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .history-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease;
            color: var(--history-text);
            background: var(--history-bg);
        }

        .history-item:hover {
            background-color: var(--input-bg);
        }

        .history-item strong {
            color: var(--primary-color);
        }

        .history-item div:last-child {
            color: var(--secondary-color);
            font-weight: bold;
        }

        .chart-container {
            margin-top: 20px;
            padding: 20px;
            background: var(--chart-bg);
            border-radius: 10px;
            height: 300px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .maintenance-alert {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: #ffffff;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .theme-switch {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .theme-switch button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        @media (min-width: 768px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
                padding: 30px;
            }

            .header {
                padding: 30px;
            }

            .header h1 {
                font-size: 2.5em;
            }

            .header p {
                font-size: 1.2em;
            }
            
            .location-group {
                grid-template-columns: 2fr 1fr;
            }

            .tank-container {
                width: 100px;
                height: 200px;
            }

            .btn {
                width: auto;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }

            .container {
                border-radius: 15px;
            }

            .header {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .input-section, .results-section {
                padding: 15px;
            }

            .form-group select, 
            .form-group input {
                padding: 8px 10px;
            }
            
            .weather-grid {
                grid-template-columns: 1fr;
            }

            .tank-container {
                width: 60px;
                height: 120px;
            }
        }

        .result-item {
            background: var(--result-bg);
            border: 1px solid var(--result-border);
            color: var(--result-text);
        }

        .instructions {
            background: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .instructions h3 {
            color: var(--primary-color);
        }

        .instructions p {
            color: var(--text-color);
        }

        .loading {
            background: var(--card-bg);
            color: var(--text-color);
        }

        .error-message {
            background: #ff5252;
            color: #ffffff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .tank-level {
            background: var(--primary-color);
            border: 2px solid var(--border-color);
        }

        .tank-level-text {
            color: var(--text-color);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .nav-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .nav-button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .nav-button i {
            font-size: 1.2em;
        }
    </style>
    <!-- Agregar Font Awesome para los iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <button class="nav-button" onclick="window.location.href='monitor.html'">
        <i class="fas fa-water"></i>
        Monitor de Agua
    </button>

    <div class="container">
        <div class="header">
            <h1>üå± Calculadora de Riego Agr√≠cola</h1>
            <p>Optimiza el riego de tus cultivos con datos clim√°ticos en tiempo real</p>
        </div>

        <div class="main-content">
            <div class="input-section">
                <h2>üìã Datos del Cultivo</h2>
                
                <form id="irrigationForm">
                    <div class="form-group">
                        <label for="plantType">üåæ Tipo de Planta:</label>
                        <select id="plantType" required>
                            <option value="">Selecciona una planta</option>
                            <option value="maiz">üåΩ Ma√≠z</option>
                            <option value="tomate">üçÖ Tomate</option>
                            <option value="alfalfa">üåø Alfalfa</option>
                            <option value="frijol">ü´ò Frijol</option>
                            <option value="chile">üå∂Ô∏è Chile</option>
                            <option value="lechuga">ü•¨ Lechuga</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="soilType">üèîÔ∏è Tipo de Suelo:</label>
                        <select id="soilType" required>
                            <option value="">Selecciona el tipo de suelo</option>
                            <option value="arenoso">üèñÔ∏è Arenoso</option>
                            <option value="arcilloso">ü™® Arcilloso</option>
                            <option value="limoso">üü§ Limoso</option>
                            <option value="franco">üå± Franco</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="area">üìê √Årea del cultivo (m¬≤):</label>
                        <input type="number" id="area" min="1" max="10000" required placeholder="Ej: 100">
                    </div>

                    <div class="form-group">
                        <label for="tankDiameter">üìè Di√°metro del tanque (cm):</label>
                        <input type="number" id="tankDiameter" min="0" step="0.1" placeholder="Ej: 6">
                    </div>
                    <div class="form-group">
                        <label for="tankHeight">üìè Altura total del tanque (cm):</label>
                        <input type="number" id="tankHeight" min="0" step="0.1" placeholder="Ej: 20">
                    </div>

                    <!-- Comentado temporalmente hasta implementar la conexi√≥n con el sensor
                    <div class="form-group">
                        <label for="sensorIP">üåê IP del sensor:</label>
                        <input type="text" id="sensorIP" placeholder="Ej: 192.168.1.100">
                    </div>
                    -->

                    <div class="form-group">
                        <button type="button" class="btn btn-secondary" onclick="getWaterLevel()">üîÑ Consultar nivel de agua</button>
                    </div>

                    <div class="tank-visualization">
                        <div class="tank-container">
                            <div class="tank">
                                <div id="waterLevel" class="water-level"></div>
                                <div id="tankLevelText" class="water-level-text">0%</div>
                            </div>
                        </div>
                        <div class="tank-info">
                            <div class="volume-info">
                                <p>Volumen inicial: <span id="initialVolume">0</span> </p>
                                <p>Volumen actual: <span id="currentVolume">0</span> </p>
                                <p>Agua consumida: <span id="consumedVolume">0</span></p>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üìç Ubicaci√≥n:</label>
                        <div class="location-group">
                            <input type="text" id="location" placeholder="Ej: Torre√≥n, Coahuila" required>
                            <button type="button" class="btn btn-secondary" onclick="getCurrentLocation()">üìç Mi ubicaci√≥n</button>
                        </div>
                    </div>

                    <button type="submit" class="btn">üíß Calcular Riego</button>
                </form>
            </div>

            <div class="results-section">
                <h2>üìä Resultados y Recomendaciones</h2>
                
                <div id="weatherInfo" style="display: none;"></div>
                <div id="recommendations" style="display: none;"></div>
                <div id="loading" style="display: none;" class="loading">
                    <p>üîÑ Obteniendo datos clim√°ticos...</p>
                </div>
                <div id="error" style="display: none;" class="error"></div>
                
                <div class="recommendation" style="display: block;">
                    <h3>‚ÑπÔ∏è Instrucciones</h3>
                    <p>1. Selecciona el tipo de planta que deseas cultivar</p>
                    <p>2. Elige el tipo de suelo de tu terreno</p>
                    <p>3. Indica el √°rea en metros cuadrados</p>
                    <p>4. Proporciona tu ubicaci√≥n para obtener datos clim√°ticos</p>
                    <p>5. Haz clic en "Calcular Riego" para obtener recomendaciones personalizadas</p>
                </div>

                <div class="history-section">
                    <h3>üìä Historial de Riego</h3>
                    <div class="history-list" id="irrigationHistory">
                        <!-- El historial se llenar√° din√°micamente -->
            </div>
        </div>

                <div class="chart-container">
                    <canvas id="waterConsumptionChart"></canvas>
    </div>

                <div id="maintenanceAlerts">
                    <!-- Las alertas se mostrar√°n din√°micamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Agregar Chart.js para los gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const API_KEY = 'df08cb63089163374d7841e4f9715403';
        // Tabla de recomendaciones de riego (litros por m¬≤ por semana)
        const irrigationData = {
            maiz: {
                arenoso: { base: 25, factor: 1.3 },
                arcilloso: { base: 20, factor: 1.1 },
                limoso: { base: 22, factor: 1.2 },
                franco: { base: 23, factor: 1.15 }
            },
            tomate: {
                arenoso: { base: 30, factor: 1.4 },
                arcilloso: { base: 25, factor: 1.2 },
                limoso: { base: 27, factor: 1.3 },
                franco: { base: 28, factor: 1.25 }
            },
            alfalfa: {
                arenoso: { base: 35, factor: 1.5 },
                arcilloso: { base: 28, factor: 1.3 },
                limoso: { base: 30, factor: 1.4 },
                franco: { base: 32, factor: 1.35 }
            },
            frijol: {
                arenoso: { base: 20, factor: 1.2 },
                arcilloso: { base: 16, factor: 1.0 },
                limoso: { base: 18, factor: 1.1 },
                franco: { base: 19, factor: 1.05 }
            },
            chile: {
                arenoso: { base: 28, factor: 1.3 },
                arcilloso: { base: 23, factor: 1.1 },
                limoso: { base: 25, factor: 1.2 },
                franco: { base: 26, factor: 1.15 }
            },
            lechuga: {
                arenoso: { base: 15, factor: 1.1 },
                arcilloso: { base: 12, factor: 0.9 },
                limoso: { base: 13, factor: 1.0 },
                franco: { base: 14, factor: 0.95 }
            }
        };

        // Informaci√≥n de plantas (mover al √°mbito global)
        const plantInfo = {
            maiz: { name: "Ma√≠z", icon: "üåΩ", cycle: "120-150 d√≠as" },
            tomate: { name: "Tomate", icon: "üçÖ", cycle: "90-120 d√≠as" },
            alfalfa: { name: "Alfalfa", icon: "üåø", cycle: "Perenne" },
            frijol: { name: "Frijol", icon: "ü´ò", cycle: "90-100 d√≠as" },
            chile: { name: "Chile", icon: "üå∂Ô∏è", cycle: "120-150 d√≠as" },
            lechuga: { name: "Lechuga", icon: "ü•¨", cycle: "60-80 d√≠as" }
        };

        // Informaci√≥n de suelos (mover al √°mbito global)
        const soilInfo = {
            arenoso: { name: "Arenoso", icon: "üèñÔ∏è", drainage: "Excelente", retention: "Baja" },
            arcilloso: { name: "Arcilloso", icon: "ü™®", drainage: "Pobre", retention: "Alta" },
            limoso: { name: "Limoso", icon: "üü§", drainage: "Bueno", retention: "Media" },
            franco: { name: "Franco", icon: "üå±", drainage: "Muy bueno", retention: "√ìptima" }
        };

        document.getElementById('irrigationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const plantType = document.getElementById('plantType').value;
            const soilType = document.getElementById('soilType').value;
            const area = parseFloat(document.getElementById('area').value);
            const location = document.getElementById('location').value;
            const tankWidth = parseFloat(document.getElementById('tankDiameter').value);
            const tankLength = parseFloat(document.getElementById('tankHeight').value);
            const tankHeight = parseFloat(document.getElementById('tankHeight').value);

            if (!plantType || !soilType || isNaN(area) || !location || 
                isNaN(tankWidth) || isNaN(tankLength) || isNaN(tankHeight)) {
                showError('Por favor, completa todos los campos correctamente.');
                return;
            }

            // Ocultar las instrucciones
            document.querySelector('.recommendation').style.display = 'none';
            
            showLoading();
            
            try {
                // Obtener la distancia del sensor
                const distance = await getSensorDistance();
                console.log('Distancia obtenida:', distance, 'cm');
                
                // Calcular el volumen de agua
                const volume = calculateWaterVolume(distance, tankWidth, tankLength);
                console.log('Volumen calculado:', volume, 'm¬≥');
                
                // Asegurarnos de que los valores sean n√∫meros v√°lidos
                const validDistance = parseFloat(distance);
                const validTankHeight = parseFloat(tankHeight);
                
                if (isNaN(validDistance) || isNaN(validTankHeight)) {
                    console.error('Valores inv√°lidos:', { distance, tankHeight });
                    showError('Error: Valores de distancia o altura del tanque inv√°lidos');
                    return;
                }
                
                // Actualizar la visualizaci√≥n del tanque
                updateTankVisualization(validDistance, validTankHeight);
                
                // Obtener datos del clima
                const weatherData = await getWeatherData(location);
                const recommendation = calculateIrrigation(plantType, soilType, area, weatherData);
                
                // Agregar al historial
                addToHistory({
                    plantType: plantType,
                    waterUsed: recommendation.totalWater,
                    weather: weatherData,
                    distance: distance,
                    volume: volume
                });
                
                // Mostrar resultados
                document.getElementById('weatherInfo').style.display = 'block';
                document.getElementById('recommendations').style.display = 'block';
                
                displayWeatherInfo(weatherData, location);
                displayRecommendation(recommendation, plantType, soilType, area);
                
                // Verificar mantenimiento
                checkMaintenance();
                
            } catch (error) {
                console.error('Error:', error);
                showError('Error al obtener datos. Verifica la conexi√≥n con el sensor.');
            } finally {
                hideLoading();
            }
        });

        async function getWeatherData(location) {
            try {
                // Verificar si tenemos datos en cach√©
                const cachedData = getCachedWeatherData(location);
                if (cachedData) {
                    console.log('üå°Ô∏è Usando datos del clima en cach√©:');
                    console.log('üìç Ubicaci√≥n:', cachedData.location);
                    console.log('üå°Ô∏è Temperatura:', cachedData.temperature + '¬∞C');
                    console.log('üíß Humedad:', cachedData.humidity + '%');
                    console.log('‚è∞ √öltima actualizaci√≥n:', new Date(cachedData.timestamp).toLocaleTimeString());
                    return cachedData;
                }

                console.log('üîÑ Haciendo llamada a la API de OpenWeatherMap...');
                let lat, lon;

                // Verificar si la entrada son coordenadas (formato: "latitud, longitud")
                const coordMatch = location.match(/^\s*([-+]?\d*\.?\d+)\s*,\s*([-+]?\d*\.?\d+)\s*$/);
                
                if (coordMatch) {
                    console.log('üìç Usando coordenadas directamente');
                    lat = parseFloat(coordMatch[1]);
                    lon = parseFloat(coordMatch[2]);
                } else {
                    console.log('üîç Buscando coordenadas para:', location);
                    // Si no son coordenadas, buscamos la ubicaci√≥n por nombre
                    const geoResponse = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(location)}&limit=1&appid=${API_KEY}`);
                    const geoData = await geoResponse.json();
                    
                    if (!geoData.length) {
                        throw new Error('Ubicaci√≥n no encontrada');
                    }

                    lat = geoData[0].lat;
                    lon = geoData[0].lon;
                    console.log('üìç Coordenadas encontradas:', lat, lon);
                }

                // Obtenemos los datos del clima
                console.log('üå§Ô∏è Obteniendo datos del clima...');
                const weatherResponse = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&lang=es&appid=${API_KEY}`);
                
                if (!weatherResponse.ok) {
                    const errorData = await weatherResponse.json();
                    throw new Error(`Error de la API: ${errorData.message || weatherResponse.statusText}`);
                }

                const weatherData = await weatherResponse.json();
                console.log('‚úÖ Datos del clima obtenidos exitosamente');

                const formattedData = {
                        location: location,
                    temperature: Math.round(weatherData.main.temp),
                    humidity: weatherData.main.humidity,
                    precipitation: weatherData.rain ? weatherData.rain['1h'] || 0 : 0,
                    windSpeed: Math.round(weatherData.wind.speed * 3.6), // Convertir m/s a km/h
                    condition: weatherData.weather[0].description,
                    timestamp: Date.now() // Agregamos timestamp para el cach√©
                };

                // Guardar en cach√©
                console.log('üíæ Guardando datos en cach√©...');
                saveWeatherDataToCache(location, formattedData);
                console.log('‚úÖ Datos guardados en cach√©');

                return formattedData;
            } catch (error) {
                console.error('‚ùå Error detallado:', error);
                if (error.message.includes('401')) {
                    throw new Error('Error de autenticaci√≥n con la API. Por favor, verifica que la API key sea correcta y est√© activa.');
                }
                throw new Error(`Error al obtener datos clim√°ticos: ${error.message}`);
            }
        }

        // Funci√≥n para guardar datos del clima en cach√©
        function saveWeatherDataToCache(location, data) {
            const cacheData = {
                data: data,
                timestamp: Date.now()
            };
            localStorage.setItem(`weather_${location}`, JSON.stringify(cacheData));
        }

        // Funci√≥n para obtener datos del clima desde cach√©
        function getCachedWeatherData(location) {
            const cachedData = localStorage.getItem(`weather_${location}`);
            if (!cachedData) {
                console.log('‚ùå No hay datos en cach√© para:', location);
                return null;
            }

            const { data, timestamp } = JSON.parse(cachedData);
            const oneHour = 60 * 60 * 1000; // 1 hora en milisegundos
            const timeDiff = Date.now() - timestamp;

            // Verificar si los datos tienen menos de 1 hora
            if (timeDiff < oneHour) {
                console.log('‚è∞ Tiempo restante en cach√©:', Math.round((oneHour - timeDiff) / 60000), 'minutos');
                return data;
            }

            // Si los datos son m√°s antiguos de 1 hora, eliminarlos
            console.log('üïí Datos en cach√© expirados, eliminando...');
            localStorage.removeItem(`weather_${location}`);
            return null;
        }

        // Funci√≥n para limpiar el cach√©
        function clearWeatherCache() {
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.startsWith('weather_')) {
                    localStorage.removeItem(key);
                }
            });
        }

        function calculateIrrigation(plantType, soilType, area, weatherData) {
            const baseData = irrigationData[plantType][soilType];
            let waterPerM2 = baseData.base;
            
            // Ajustes basados en clima
            if (weatherData.temperature > 25) {
                waterPerM2 *= 1.2; // M√°s agua en clima caliente
            } else if (weatherData.temperature < 15) {
                waterPerM2 *= 0.8; // Menos agua en clima fr√≠o
            }
            
            if (weatherData.humidity < 50) {
                waterPerM2 *= 1.15; // M√°s agua en baja humedad
            } else if (weatherData.humidity > 70) {
                waterPerM2 *= 0.9; // Menos agua en alta humedad
            }
            
            if (weatherData.precipitation > 5) {
                waterPerM2 *= 0.7; // Reducir riego si hay precipitaci√≥n
            }
            
            // Aplicar factor del suelo
            waterPerM2 *= baseData.factor;
            
            const totalWater = waterPerM2 * area;
            const dailyWater = totalWater / 7;
            
            return {
                waterPerM2: Math.round(waterPerM2 * 10) / 10,
                totalWater: Math.round(totalWater),
                dailyWater: Math.round(dailyWater),
                frequency: calculateFrequency(soilType, weatherData),
                sessions: calculateSessions(totalWater)
            };
        }

        function calculateFrequency(soilType, weatherData) {
            if (soilType === 'arenoso') return 'Diario';
            if (soilType === 'arcilloso') return 'Cada 3-4 d√≠as';
            if (weatherData.precipitation > 5) return 'Cada 2-3 d√≠as';
            return 'Cada 2 d√≠as';
        }

        function calculateSessions(totalWater) {
            if (totalWater < 50) return '1 sesi√≥n por d√≠a';
            if (totalWater < 200) return '2 sesiones por d√≠a';
            return '3 sesiones por d√≠a';
        }

        function displayWeatherInfo(weatherData, location) {
            const weatherInfo = document.getElementById('weatherInfo');
            weatherInfo.innerHTML = `
                <h3>üå§Ô∏è Informaci√≥n del Clima en ${location}</h3>
                <p>üå°Ô∏è Temperatura: ${weatherData.temperature}¬∞C</p>
                <p>üíß Humedad: ${weatherData.humidity}%</p>
                <p>üåßÔ∏è Precipitaci√≥n: ${weatherData.precipitation} mm</p>
                <p>‚è∞ √öltima actualizaci√≥n: ${new Date().toLocaleString()}</p>
            `;
        }

        function displayRecommendation(recommendation, plantType, soilType, area) {
            const results = document.getElementById('recommendations');
            results.style.display = 'block'; // Asegurar que la secci√≥n sea visible
            
            const plant = plantInfo[plantType];
            const soil = soilInfo[soilType];
            
            results.innerHTML = `
                <div class="result-item">
                    <h3>üíß Recomendaciones de Riego</h3>
                    <div class="recommendation-details">
                        <div class="detail-item">
                            <span class="detail-label">Tipo de Planta:</span>
                            <span class="detail-value">${plant.icon} ${plant.name}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Ciclo de Cultivo:</span>
                            <span class="detail-value">${plant.cycle}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Tipo de Suelo:</span>
                            <span class="detail-value">${soil.icon} ${soil.name}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Drenaje del Suelo:</span>
                            <span class="detail-value">${soil.drainage}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Retenci√≥n de Agua:</span>
                            <span class="detail-value">${soil.retention}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">√Årea del Cultivo:</span>
                            <span class="detail-value">${area} m¬≤</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Agua por m¬≤:</span>
                            <span class="detail-value">${recommendation.waterPerM2} L/m¬≤</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Agua Total Necesaria:</span>
                            <span class="detail-value">${recommendation.totalWater} L</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Agua Diaria:</span>
                            <span class="detail-value">${recommendation.dailyWater} L</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Frecuencia de Riego:</span>
                            <span class="detail-value">${recommendation.frequency}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Sesiones de Riego:</span>
                            <span class="detail-value">${recommendation.sessions}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async function(position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        
                        try {
                            // Obtener el nombre del lugar usando la API de OpenWeatherMap
                            const response = await fetch(`https://api.openweathermap.org/geo/1.0/reverse?lat=${lat}&lon=${lon}&limit=1&appid=${API_KEY}`);
                            const data = await response.json();
                            
                            if (data && data.length > 0) {
                                const location = data[0];
                                let locationName = '';
                                
                                // Construir el nombre del lugar
                                if (location.name) {
                                    locationName = location.name;
                                    if (location.state) {
                                        locationName += `, ${location.state}`;
                                    }
                                    if (location.country) {
                                        locationName += `, ${location.country}`;
                                    }
                                }
                                
                                document.getElementById('location').value = locationName;
                            } else {
                                showError('No se pudo obtener el nombre del lugar.');
                            }
                        } catch (error) {
                            console.error('Error al obtener ubicaci√≥n:', error);
                            showError('Error al obtener la ubicaci√≥n autom√°ticamente.');
                        }
                    },
                    function(error) {
                        console.error('Error de geolocalizaci√≥n:', error);
                        showError('Error al acceder a la ubicaci√≥n. Verifica los permisos del navegador.');
                    }
                );
            } else {
                showError('Tu navegador no soporta geolocalizaci√≥n.');
            }
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('weatherInfo').style.display = 'none';
            document.getElementById('recommendations').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        async function getWaterLevel() {
            const diameter = parseFloat(document.getElementById('tankDiameter').value);
            const height = parseFloat(document.getElementById('tankHeight').value);

            if (!diameter || !height) {
                showError('Por favor, completa las dimensiones del tanque.');
                return;
            }

            try {
                // Obtener la distancia del sensor
                const distance = await getSensorDistance();
                console.log('Distancia obtenida:', distance, 'cm');

                // Calcular altura de agua
                const waterHeight = height - distance;
                if (waterHeight < 0) {
                    showError('La distancia medida es mayor que la altura del tanque.');
                    return;
                }

                // Calcular volumen (cilindro): V = œÄ * r^2 * h
                // Convertir de cm a m para el c√°lculo
                const radius = (diameter / 2);// / 100; // Convertir a metros
                const waterHeightM = waterHeight;// / 100; // Convertir a metros
                const heightM = height;// / 100; // Convertir a metros

                const currentVolume = Math.PI * Math.pow(radius, 2) * waterHeightM; // m¬≥
                const initialVolume = Math.PI * Math.pow(radius, 2) * heightM; // m¬≥
                const consumedVolume = initialVolume - currentVolume;

                // Actualizar visualizaci√≥n
                const waterLevelElement = document.getElementById('waterLevel');
                const waterPercentage = (waterHeight / height) * 100;
                waterLevelElement.style.height = `${waterPercentage}%`;

                // Funci√≥n para formatear el volumen con la unidad apropiada
                function formatVolume(volumeInM3) {
                    const volumeInL = Math.round(volumeInM3 * 1000);
                    if (volumeInL < 1000) {
                        return `${volumeInL} L`;
                    } else {
                        return `${(volumeInL / 1000).toFixed(2)} m¬≥`;
                    }
                }

                // Actualizar informaci√≥n de volumen con unidades apropiadas
                document.getElementById('initialVolume').textContent = formatVolume(initialVolume);
                document.getElementById('currentVolume').textContent = formatVolume(currentVolume);
                document.getElementById('consumedVolume').textContent = formatVolume(consumedVolume);
                document.getElementById('tankLevelText').textContent = `${waterPercentage.toFixed(1)}%`;

                // Cambiar el color seg√∫n el nivel
                if (waterPercentage < 20) {
                    waterLevelElement.style.backgroundColor = '#ff5252'; // Rojo para nivel bajo
                } else if (waterPercentage < 50) {
                    waterLevelElement.style.backgroundColor = '#ffd740'; // Amarillo para nivel medio
                } else {
                    waterLevelElement.style.backgroundColor = '#4CAF50'; // Verde para nivel alto
                }

                hideError();
            } catch (error) {
                console.error('Error al calcular el nivel de agua:', error);
                showError('Error al calcular el nivel de agua.');
            }
        }

        // Funci√≥n para alternar el tema
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                themeIcon.textContent = 'üåô';
                themeText.textContent = 'Modo Oscuro';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                themeIcon.textContent = '‚òÄÔ∏è';
                themeText.textContent = 'Modo Claro';
                localStorage.setItem('theme', 'dark');
            }
            
            // Actualizar el gr√°fico con los nuevos colores
            updateWaterConsumptionChart();
        }

        // Cargar tema guardado
        if (localStorage.getItem('theme') === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
            document.getElementById('themeText').textContent = 'Modo Claro';
        }

        // Historial de riego
        let irrigationHistory = JSON.parse(localStorage.getItem('irrigationHistory')) || [];

        function addToHistory(data) {
            const historyItem = {
                date: new Date().toLocaleString(),
                plantType: data.plantType,
                waterUsed: data.waterUsed,
                weather: data.weather
            };
            
            irrigationHistory.unshift(historyItem);
            if (irrigationHistory.length > 10) {
                irrigationHistory.pop();
            }
            
            localStorage.setItem('irrigationHistory', JSON.stringify(irrigationHistory));
            updateHistoryDisplay();
            updateWaterConsumptionChart();
        }

        function updateHistoryDisplay() {
            const historyList = document.getElementById('irrigationHistory');
            historyList.innerHTML = irrigationHistory.map(item => `
                <div class="history-item">
                    <div>
                        <strong>${item.plantType}</strong>
                        <div>${item.date}</div>
                    </div>
                    <div>${item.waterUsed}</div>
                </div>
            `).join('');
        }

        // Gr√°fico de consumo de agua
        let waterChart;

        function updateWaterConsumptionChart() {
            const ctx = document.getElementById('waterConsumptionChart').getContext('2d');
            
            if (waterChart) {
                waterChart.destroy();
            }

            const labels = irrigationHistory.map(item => {
                const date = new Date(item.date);
                return date.toLocaleDateString('es-ES', { 
                    day: '2-digit',
                    month: 'short'
                });
            });
            
            const data = irrigationHistory.map(item => {
                const volume = parseFloat(item.waterUsed);
                return isNaN(volume) ? 0 : volume;
            });

            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(76, 175, 80, 0.8)');
            gradient.addColorStop(1, 'rgba(76, 175, 80, 0.1)');

            waterChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Consumo de Agua (L)',
                        data: data,
                        borderColor: '#4CAF50',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#4CAF50',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-color'),
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#4CAF50',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return `Consumo: ${context.raw} L`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: getComputedStyle(document.body).getPropertyValue('--chart-grid'),
                                drawBorder: false
                            },
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--chart-text'),
                                font: {
                                    size: 12
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--chart-text'),
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }

        // Sistema de alertas de mantenimiento
        function checkMaintenance() {
            const alerts = [];
            const lastMaintenance = localStorage.getItem('lastMaintenance');
            const now = new Date();
            
            if (!lastMaintenance || (now - new Date(lastMaintenance)) > (30 * 24 * 60 * 60 * 1000)) {
                alerts.push({
                    type: 'maintenance',
                    message: '‚ö†Ô∏è Es recomendable realizar mantenimiento del sistema de riego'
                });
            }

            if (irrigationHistory.length > 0) {
                const recentUsage = irrigationHistory.slice(0, 3);
                const avgUsage = recentUsage.reduce((sum, item) => {
                    const volume = parseFloat(item.waterUsed);
                    return sum + (isNaN(volume) ? 0 : volume);
                }, 0) / recentUsage.length;

                if (avgUsage > 1000) {
                    alerts.push({
                        type: 'high-usage',
                        message: 'üíß Consumo de agua elevado detectado'
                    });
                }
            }

            displayAlerts(alerts);
        }

        function displayAlerts(alerts) {
            const alertsContainer = document.getElementById('maintenanceAlerts');
            alertsContainer.innerHTML = alerts.map(alert => `
                <div class="maintenance-alert">
                    ${alert.message}
                </div>
            `).join('');
        }

        // Inicializar
        updateHistoryDisplay();
        updateWaterConsumptionChart();
        checkMaintenance();

        // Funci√≥n para obtener la distancia del sensor
        async function getSensorDistance() {
            // Por ahora, retornamos un valor por defecto de 10cm
            console.log('Usando valor por defecto para la distancia: 10cm');
            return 10; // 10 cent√≠metros por defecto
            
            /* C√≥digo original comentado para cuando tengas el sensor
            try {
                // Intentamos primero con una petici√≥n directa
                try {
                    const response = await fetch('http://10.10.7.3', {
                        method: 'GET',
                        headers: {
                             'Accept': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Error en la respuesta del sensor');
                    }
                    
                    const data = await response.json();
                    console.log('Datos del sensor:', data);
                    
                    if (typeof data.distancia_cm === 'undefined') {
                        throw new Error('El valor distancia_cm no est√° presente en la respuesta');
                    }
                    
                    return data.distancia_cm;
                } catch (directError) {
                    console.log('Error en petici√≥n directa:', directError);
                    
                    // Si falla la petici√≥n directa, intentamos con una petici√≥n JSONP
                    return new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = `http://10.10.7.3?callback=handleSensorData`;
                        script.onerror = () => {
                            console.log('Error en petici√≥n JSONP, usando valor por defecto');
                            resolve(20); // Valor por defecto
                        };
                        
                        window.handleSensorData = function(data) {
                            if (data && typeof data.distancia_cm !== 'undefined') {
                                resolve(data.distancia_cm);
                            } else {
                                resolve(20); // Valor por defecto
                            }
                            document.body.removeChild(script);
                            delete window.handleSensorData;
                        };
                        
                        document.body.appendChild(script);
                    });
                }
            } catch (error) {
                console.error('Error al obtener la distancia:', error);
                return 20; // Valor por defecto en caso de error
            }
            */
        }

        // Funci√≥n para calcular el volumen de agua
        function calculateWaterVolume(distance, tankWidth, tankLength) {
            // Convertir la distancia de cm a metros
            const distanceInMeters = distance / 100;
            
            // Calcular el volumen en metros c√∫bicos
            const volume = tankWidth * tankLength * distanceInMeters;
            
            return volume;
        }

        // Funci√≥n para actualizar la visualizaci√≥n del tanque
        function updateTankVisualization(distance, tankHeight) {
            try {
                const tankLevel = document.getElementById('waterLevel');
                const tankLevelText = document.getElementById('tankLevelText');
                
                if (!tankLevel || !tankLevelText) {
                    console.error('No se encontraron los elementos del tanque');
                    return;
                }
                
                if (typeof distance !== 'number' || typeof tankHeight !== 'number') {
                    console.error('Valores inv√°lidos:', { distance, tankHeight });
                    return;
                }
                
                // Calcular el porcentaje de llenado
                const fillPercentage = ((tankHeight - distance) / tankHeight) * 100;
                const clampedPercentage = Math.max(0, Math.min(100, fillPercentage));
                
                // Actualizar la altura del nivel de agua
                tankLevel.style.height = `${clampedPercentage}%`;
                
                // Actualizar el texto
                tankLevelText.textContent = `${clampedPercentage.toFixed(1)}%`;
                
                // Cambiar el color seg√∫n el nivel
                if (clampedPercentage < 20) {
                    tankLevel.style.backgroundColor = '#ff5252'; // Rojo para nivel bajo
                } else if (clampedPercentage < 50) {
                    tankLevel.style.backgroundColor = '#ffd740'; // Amarillo para nivel medio
                } else {
                    tankLevel.style.backgroundColor = '#4CAF50'; // Verde para nivel alto
                }
            } catch (error) {
                console.error('Error al actualizar la visualizaci√≥n del tanque:', error);
            }
        }
    </script>
</body>
</html>
